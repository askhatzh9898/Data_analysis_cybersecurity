# Анализ сетевого трафика для обнаружения угроз безопасности

---

## Аннотация

В данной работе представлен воспроизводимый конвейер анализа сетевой телеметрии, полученной из перехваченных пакетов. Исходные PCAP-файлы обрабатываются системой Zeek для генерации структурированных журналов, которые затем нормализуются, обогащаются данными об угрозах и анализируются статистическими методами. В результате работы конвейера выявлены два хоста с индикаторами компрометации, что демонстрирует эффективность многоуровневого обогащения данных для выявления событий, значимых с точки зрения безопасности, в большом объёме сетевых данных.

---

## 1. Введение

Анализ сетевого трафика остаётся краеугольным камнем мониторинга безопасности предприятий. Однако объём необработанных пакетных данных требует автоматизированных конвейеров обработки, способных извлекать, нормализовать и обогащать телеметрию для эффективного анализа. В данной работе реализован такой конвейер с использованием инструментов с открытым исходным кодом, пригодных для развёртывания в средах с ограниченными ресурсами.

**Цели исследования:**
1. Преобразование необработанных перехваченных пакетов в структурированные наборы данных, пригодные для запросов
2. Применение унифицированной схемы, обеспечивающей корреляцию между различными источниками
3. Обогащение сетевых событий индикаторами угроз
4. Выявление аномальных паттернов с использованием интерпретируемых статистических методов

---

## 2. Выбор источников данных

### 2.1 Первичные данные: журналы Zeek

Zeek (ранее известный как Bro) был выбран в качестве системы мониторинга сетевой безопасности по следующим причинам:

| Критерий | Возможности Zeek |
|----------|------------------|
| Охват протоколов | Нативный разбор более 35 прикладных протоколов |
| Формат вывода | Структурированные журналы (TSV или JSON) с типизированными полями |
| Офлайн-анализ | Поддержка воспроизведения PCAP через `zeek -r` |
| Расширяемость | Возможность написания скриптов для анализа пользовательских протоколов |

В анализе использовались `conn.log` (сводки соединений) и `dns.log` (DNS-транзакции), которые в совокупности обеспечивают видимость топологии сети и паттернов разрешения имён.

### 2.2 Справочные данные: разведка угроз

Для обогащения данными об угрозах использовались локальные текстовые списки блокировки:
- **Чёрный список IP-адресов:** известная инфраструктура командных серверов (C2)
- **Чёрный список доменов:** вредоносные домены, включая паттерны DGA

Данный подход был выбран вместо API-сервисов разведки угроз для обеспечения воспроизводимости и устранения внешних зависимостей в процессе анализа.

---

## 3. Конвейер обработки

Конвейер реализует пятиэтапную архитектуру с чётким разделением между исходными данными, промежуточными артефактами и конечными результатами.

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  ЗАГРУЗКА   │───▶│НОРМАЛИЗАЦИЯ │───▶│ ОБОГАЩЕНИЕ  │───▶│   АНАЛИЗ    │───▶│   ЭКСПОРТ   │
│  Парсинг    │    │ Унифициров. │    │  Признаки   │    │ Статистика  │    │  CSV/JSON   │
│ Zeek JSON   │    │   схема     │    │    угроз    │    │ и оповещения│    │ + метаданные│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

### 3.1 Этап 1: Загрузка

JSON-журналы Zeek разбираются в DataFrame библиотеки pandas с применением схемы. Загрузчик обрабатывает:
- Формат Zeek JSON с разделением записей переносом строки
- Преобразование временных меток (epoch или ISO 8601 в `datetime64[ns, UTC]`)
- Nullable-типы целых чисел для сохранения семантики отсутствующих значений

### 3.2 Этап 2: Нормализация

Имена полей отображаются в унифицированную схему, согласованную с соглашениями Elastic Common Schema:

| Поле Zeek | Унифицированное поле | Обоснование |
|-----------|---------------------|-------------|
| `id.orig_h` | `src_ip` | Единообразное именование для всех типов журналов |
| `id.resp_h` | `dst_ip` | Возможность операций JOIN |
| `proto` | `protocol` | Явное, несокращённое название |
| `ts` | `timestamp` | Стандартное временное поле |

Столбец-дискриминатор `log_type` позволяет фильтровать данные после объединения разнородных журналов.

### 3.3 Этап 3: Обогащение

Обогащение данными разведки угроз добавляет булевый столбец `ti_match`. Система сопоставления поддерживает:
- Точное сопоставление IP через поиск в множестве (сложность O(1))
- Сопоставление доменов с наследованием поддоменов (например, `evil.com` соответствует `*.evil.com`)

### 3.4 Этап 4: Анализ

Статистический анализ использует интерпретируемые метрики без применения машинного обучения:

| Метрика | Расчёт | Значение для безопасности |
|---------|--------|---------------------------|
| Доля неудачных соединений | `(S0 + REJ) / всего` | Сканирование портов, блокировки межсетевым экраном |
| Доля NXDOMAIN | `NXDOMAIN / всего DNS` | Алгоритмы генерации доменов (DGA) |
| Соотношение байтов | `отправлено / получено` | Эксфильтрация данных |

### 3.5 Этап 5: Экспорт

Результаты сохраняются в переносимых форматах с контрольными суммами SHA-256 для проверки воспроизводимости.

---

## 4. Основные аналитические наблюдения

Анализ тестового набора данных (12 соединений, 9 DNS-запросов) дал следующие результаты:

### 4.1 Распределение по протоколам

| Протокол | Соединений | Процент |
|----------|------------|---------|
| TCP | 9 | 75,0% |
| UDP | 3 | 25,0% |

TCP-трафик преимущественно состоял из HTTPS (порт 443) и SSH (порт 22), что соответствует типичным паттернам исходящего трафика предприятия.

### 4.2 Результаты обнаружения аномалий

| Индикатор | Значение | Порог | Статус |
|-----------|----------|-------|--------|
| Доля неудачных соединений | 33,3% | >10% | **ТРЕВОГА** |
| Доля NXDOMAIN | 33,3% | >30% | **ТРЕВОГА** |
| Совпадения с индикаторами угроз | 6 | >0 | **ТРЕВОГА** |

### 4.3 Хосты, требующие расследования

| IP-адрес источника | Оценка риска | Индикаторы |
|--------------------|--------------|------------|
| 192.168.1.200 | 41 | 3 совпадения TI, 3 NXDOMAIN, 1 неудачное соединение |
| 192.168.1.110 | 36 | 3 совпадения TI, 3 неудачных соединения (S0) |

**Хост 192.168.1.200** продемонстрировал классическое поведение DGA: быстрые DNS-запросы к случайным доменам (`asdkjqwe.xyz`, `xvnmqpfl.xyz`), возвращающие NXDOMAIN, что указывает на попытки вредоносного ПО обнаружить активную инфраструктуру управления.

**Хост 192.168.1.110** предпринял попытки соединения с тремя последовательными IP-адресами в одной подсети /24, все из которых завершились неудачей на этапе TCP-рукопожатия (состояние S0). Данный паттерн указывает либо на разведку, либо на попытку связи с неактивными C2-серверами.

---

## 5. Ограничения

1. **Размер выборки:** демонстрационный набор данных содержит всего 21 событие. Промышленные развёртывания обрабатывают миллионы событий ежедневно, что требует распределённых фреймворков обработки.

2. **GeoIP-обогащение отключено:** атрибуция страны и ASN не выполнялась из-за лицензионных ограничений базы данных. Это ограничивает геополитический анализ направлений трафика.

3. **Отсутствие временного анализа:** обнаружение периодических сигналов (beaconing) требует анализа временных рядов за продолжительные периоды. Текущая реализация рассматривает только агрегированную статистику.

4. **Статическая разведка угроз:** подход с использованием списков блокировки не позволяет обнаруживать индикаторы нулевого дня. Интеграция с потоками разведки угроз в реальном времени повысила бы охват обнаружения.

5. **Единая точка наблюдения:** анализ предполагает полную видимость сети. Зашифрованные туннели, VPN и трафик восток-запад могут избежать обнаружения.

---

## 6. Направления дальнейшей работы

1. **Масштабируемость:** миграция на Apache Spark или Polars для наборов данных, превышающих объём оперативной памяти.

2. **Временной анализ:** реализация обнаружения периодических сигналов с использованием анализа межпакетных интервалов и преобразований Фурье для выявления периодических обращений к C2.

3. **Отпечатки JA3/JA3S:** извлечение отпечатков TLS-клиентов из `ssl.log` Zeek для идентификации семейств вредоносного ПО по их криптографическим рукопожатиям.

4. **Сопоставление с MITRE ATT&CK:** корреляция обнаруженного поведения с техниками ATT&CK (например, T1071 для C2 на уровне приложений, T1568 для DGA).

5. **Автоматизированная отчётность:** генерация PDF-отчётов с визуализациями для документирования реагирования на инциденты.

---

## 7. Заключение

Данная работа демонстрирует, что значимые выводы о безопасности могут быть извлечены из сетевой телеметрии с использованием простого воспроизводимого конвейера. Сочетание протокол-ориентированного разбора (Zeek), нормализации схемы и обогащения данными разведки угроз преобразует необработанные пакетные данные в практически применимую информацию. Статистический подход — хотя и менее изощрённый по сравнению с альтернативами на основе машинного обучения — обеспечивает прозрачные, интерпретируемые результаты, пригодные для проверки аналитиком и соответствия нормативным требованиям.

---

## Список литературы

1. Paxson, V. (1999). Bro: A System for Detecting Network Intruders in Real-Time. *Computer Networks*, 31(23-24), 2435-2463.

2. Elastic. (2023). Elastic Common Schema (ECS) Reference. https://www.elastic.co/guide/en/ecs/current/

3. MaxMind. (2023). GeoLite2 Free Geolocation Data. https://dev.maxmind.com/geoip/geolite2-free-geolocation-data

4. MITRE. (2023). ATT&CK for Enterprise. https://attack.mitre.org/

---

## Приложение А: Воспроизводимость

Для воспроизведения результатов:

```bash
# Настройка окружения
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# Запуск конвейера
python scripts/pipeline.py

# Проверка контрольных сумм
cat outputs/metadata/data_checksums.json
```

Ожидаемая контрольная сумма для `enriched_network_events.csv`:
```
0443cf89da0d5c310d20ce4c36f4d82fd5697547c1cc4ecf1c90f9bbc12b5669
```

---

## Приложение Б: Глоссарий терминов

| Термин | Определение |
|--------|-------------|
| PCAP | Формат файла для захвата пакетов (Packet Capture) |
| Zeek | Система мониторинга сетевой безопасности с открытым исходным кодом |
| DGA | Алгоритм генерации доменов (Domain Generation Algorithm) |
| C2 | Командный сервер (Command and Control) |
| NXDOMAIN | Ответ DNS, указывающий на несуществующий домен |
| S0 | Состояние соединения в Zeek: отправлен SYN, ответ не получен |
| TI | Разведка угроз (Threat Intelligence) |
| ASN | Номер автономной системы (Autonomous System Number) |
| ECS | Elastic Common Schema — стандарт именования полей |
